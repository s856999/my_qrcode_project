{% extends "layout.html" %}
{% block title %}è¨‚å–®åˆ—è¡¨{% endblock %}

{% block main %}
<div class="container mt-5">
  <h2 class="text-center mb-5 fw-bold text-dark">ğŸ“‹ è¨‚å–®åˆ—è¡¨</h2>

  <div class="row g-4">
    <!-- å…§ç”¨å€ -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white text-center fw-bold fs-5 rounded-top">
          å…§ç”¨è¨‚å–®
        </div>
        <div class="card-body" id="accordionDineIn"></div>
      </div>
    </div>

    <!-- å¤–å¸¶å€ -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-success text-white text-center fw-bold fs-5 rounded-top">
          å¤–å¸¶è¨‚å–®
        </div>
        <div class="card-body" id="accordionTakeOut"></div>
      </div>
    </div>
  </div>
</div>

<script>
let currentOrders = [];
let accordionState = {}; // è¨˜éŒ„æ‰‹é¢¨ç´å±•é–‹ç‹€æ…‹

// å»ºç«‹è¨‚å–® HTML
function renderOrders(orders) {
  const dineInContainer = document.getElementById("accordionDineIn");
  const takeOutContainer = document.getElementById("accordionTakeOut");
  dineInContainer.innerHTML = "";
  takeOutContainer.innerHTML = "";

  // æŒ‰ int_out åˆ†é¡
  const grouped = {};
  orders.forEach(o => {
    if (!grouped[o.int_out]) grouped[o.int_out] = {};
    if (!grouped[o.int_out][o.number]) grouped[o.int_out][o.number] = [];
    grouped[o.int_out][o.number].push(o);
  });

  for (const [intOut, numbers] of Object.entries(grouped)) {
    for (const [number, items] of Object.entries(numbers)) {
      const total = items.reduce((sum, i) => sum + i.price * i.quantity, 0);
      const orderId = `${intOut}-${number}`;
      const isOpen = accordionState[orderId] || false;

      const itemHTML = `
        <div class="accordion-item mb-3 border rounded shadow-sm">
          <h2 class="accordion-header" id="heading${orderId}">
            <button class="accordion-button ${isOpen ? '' : 'collapsed'} fw-bold bg-light" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse${orderId}"
                    aria-expanded="${isOpen}" aria-controls="collapse${orderId}">
              <i class="bi bi-receipt me-2 text-primary"></i>#${number} è™Ÿè¨‚å–®
            </button>
          </h2>
          <div id="collapse${orderId}" class="accordion-collapse collapse ${isOpen ? 'show' : ''}"
               aria-labelledby="heading${orderId}">
            <div class="accordion-body bg-white">
              <table class="table table-sm align-middle text-center mb-3">
                <thead class="table-light">
                  <tr>
                    <th>å“é …</th>
                    <th>æ•¸é‡</th>
                    <th>å‚™è¨»</th>
                    <th>å°è¨ˆ</th>
                  </tr>
                </thead>
                <tbody>
                  ${items.map(i => `
                    <tr>
                      <td class="text-start">${i.name}</td>
                      <td>x${i.quantity}</td>
                      <td>${i.remark || '-'}</td>
                      <td class="text-end">$${i.price * i.quantity}</td>
                    </tr>
                  `).join("")}
                </tbody>
              </table>

              <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="fw-bold fs-5 text-danger">
                  ç¸½é‡‘é¡ï¼š$${total}
                </div>
              </div>

              <div class="mt-3 text-end">
                <form action="/finish_order/${number}" method="POST" style="display:inline;">
                  <button type="submit" class="btn btn-success btn-sm px-3"
                          onclick="return confirm('ç¢ºèªæ­¤è¨‚å–®å·²å®Œæˆå—ï¼Ÿ');">
                    âœ… å®Œæˆ
                  </button>
                </form>
                <form action="/delete_orders/${number}" method="POST" style="display:inline;">
                  <button type="submit" class="btn btn-danger btn-sm px-3 ms-2"
                          onclick="return confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ');">
                    ğŸ—‘ åˆªé™¤
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      `;

      const target = intOut === "å…§ç”¨" ? dineInContainer : takeOutContainer;
      target.insertAdjacentHTML("beforeend", itemHTML);
    }
  }

  // ç¶å®šé–‹é—œäº‹ä»¶
  document.querySelectorAll(".accordion-button").forEach(btn => {
    const id = btn.getAttribute("data-bs-target").replace("#collapse", "");
    btn.addEventListener("click", () => {
      accordionState[id] = !accordionState[id];
    });
  });
}

// è¼‰å…¥è¨‚å–®è³‡æ–™
function loadOrders() {
  fetch("/get_orders_json")
    .then(r => r.json())
    .then(data => {
      if (JSON.stringify(data) !== JSON.stringify(currentOrders)) {
        console.log("ğŸ”„ è¨‚å–®æ›´æ–°ä¸­...");
        currentOrders = data;
        renderOrders(data);
      }
    })
    .catch(err => console.error("è¼‰å…¥éŒ¯èª¤:", err));
}

// åˆå§‹åŒ–
loadOrders();
setInterval(loadOrders, 5000); // æ¯5ç§’åˆ·æ–°
</script>
{% endblock %}